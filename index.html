<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>V-C Calculator</title>
    <style>
        #inputField {
            display: none
        }
    </style>
</head>

<body>
    <div class="text-center card">
        <div class="container d-flex" style="    justify-content: center;">
            <div class="">
                <h1 class="text-center">Voltage-Current calculator</h1>
                <p>Enter the size of the Branch and Links</p>
                <form id="size" role="form">
                    <table class="table">
                        <tr>
                            <th>Branch Size</th>
                            <th>Link Column Size</th>
                        </tr>
                        <tr>
                            <td><input type="text" name="branch-row-size" id="branch-row-size" size="3"> *
                                <input type="text" name="branch-col-size" id="branch-col-size" size="3"></td>
                            <td>
                                <input type="text" name="link-col-size" id="link-col-size" size="3"></td>
                            </td>
                        </tr>
                    </table>
                    <input type="submit" onclick="generateMatrix(event)" class="btn btn-dark w-100" value="generate Matrix">

                </form>

                <form id="inputField" role="form" class=" form-matrix">


                    <table class="table">
                        <thead>
                            <tr>
                                <th>Branch</th>
                                <th>Link</th>
                            </tr>
                        </thead>
                        <tbody id="matrix">
                            <!-- <tr>
                                <td class="branch">
                                    <input type="text" name="field00" size="3">
                                    <input type="text" name="field01" size="3">
                                </td>
                                <td class="link">
                                    <input type="text" name="field02" size="3">
                                    <input type="text" name="field03" size="3">
                                </td>
                            </tr> -->
                        </tbody>
                    </table>



                    <br>
                    <button onclick="handleMatrixA(event, 'calc_C')" class="btn btn-primary">Calculate C</button>
                    <button onclick="handleMatrixA(event, 'calc_B')" class="btn btn-primary">Calculate B</button>
                    <button class="btn btn-dark">Follow with ZB</button>
                    <button class="btn btn-dark">Follow with YB</button>


                </form>
                <div id="resultField">
                    <h2 id="result-h2">B Matrix</h2>
                    <table class="table table-bordered">
                        <tbody id="result-body">
                            <tr>
                                <td>55</td>
                                <td>43</td>
                                <td>22</td>
                            </tr>
                            <tr>
                                <td>10</td>
                                <td>19</td>
                                <td>32</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>

    <script src="math.js"></script>
    <script type="text/javascript">
        var arr1 = math.matrix([
            [1, -0, -0],
            [1, 1, -0]
        ])
        var arr2 = math.matrix([
            [1, 0],
            [1, 0]
        ])
        console.log(math.concat(arr1, arr2))



        function generateMatrix(e) {

            e.preventDefault()
            var branch_row_size = parseInt(document.querySelector('#branch-row-size').value)
            var branch_col_size = parseInt(document.querySelector('#branch-col-size').value)
            var link_col_size = parseInt(document.querySelector('#link-col-size').value)

            if (branch_row_size < 1 || isNaN(branch_row_size) || branch_col_size < 1 || isNaN(branch_col_size) || link_col_size < 1 || isNaN(link_col_size))
                return;

            let code = ''

            for (var i = 0; i < branch_row_size; i++) {
                code += '<tr>'

                // Iterate Branch cells
                code += '<td class="branch">'
                for (var j = 0; j < branch_col_size; j++) {
                    code += `<input type="text" name="field${i}${j}" size="3">`
                }
                code += '</td>'

                // Iterate Link cells
                code += '<td class="link">'
                for (var j = 0; j < link_col_size; j++) {
                    code += `<input type="text" name="field${i}${j}" size="3">`
                }
                code += '</td>'


                code += '</tr>'
            }
            document.getElementById("matrix").innerHTML = code


            document.getElementById("inputField").style.display = "block"
        }

        function handleMatrixA(e, type_of_operation) {
            var branch_col_size = parseInt(document.querySelector('#branch-col-size').value)
            var link_col_size = parseInt(document.querySelector('#link-col-size').value)
            e.preventDefault();

            // Generate matrix From Inputs
            const {
                branchMatrix,
                linkMatrix
            } = generateMatrixFromForm()

            const {
                C_branch,
                C_link
            } = calculateMatrixC(branchMatrix, linkMatrix, branch_col_size)

            if (type_of_operation == "calc_C") {
                return printMatrix(C_branch, C_link, "C matrix")
            }
            const {
                B_tree,
                B_link
            } = calculateMatrixB(C_link, link_col_size)
            if (type_of_operation == "calc_B") {
                return printMatrix(B_tree, B_link, "B matrix")
            }

            //const ZB_B_Transpose = math.multiply(ZB, linkMatrix)
        }

        function calculateMatrixC(branchMatrix, linkMatrix, A_branch_col_size) {
            const A_tree_inverse = math.inv(branchMatrix)

            const C_link = math.multiply(A_tree_inverse, linkMatrix)

            const C_branch = math.identity(A_branch_col_size, A_branch_col_size)

            return {
                C_branch,
                C_link
            }
        }

        function calculateMatrixB(C_link, link_col_size) {
            const B_branch = math.dotMultiply(math.transpose(C_link), -1)

            // Get B_link
            const size = link_col_size
            const B_link = math.identity(size, size)

            console.log("B_branch and Link", B_branch, B_link)

            return {
                B_tree: B_branch,
                B_link
            }
        }

        function printMatrix(tree, link, h2) {
            var all_matrix = math.concat(tree, link)._data
            console.log("All matrix", all_matrix)
            var body = document.getElementById("result-body")
            html = ''
            all_matrix.forEach((arr) => {
                html += '<tr>'
                console.log(arr)
                arr.forEach((number) => {
                    html += `<td>${number}</td>`
                    console.log(number)
                })
                html += '</tr>'
            })
            body.innerHTML = html

            document.getElementById("result-h2").innerHTML = h2
        }

        function generateMatrixFromForm() {
            var branch_row_size = parseInt(document.querySelector('#branch-row-size').value)
            var branch_col_size = parseInt(document.querySelector('#branch-col-size').value)
            var link_col_size = parseInt(document.querySelector('#link-col-size').value)

            let branchMatrix = []
            let linkMatrix = []

            let branches = document.querySelectorAll(".branch input")
            let links = document.querySelectorAll(".link input")

            // Generate branch Arr
            let temp = branch_col_size
            let temp_arr = []
            for (var i = 0; i < branches.length; i++) {
                if (i % temp == 0 && i != 0) {
                    branchMatrix.push(temp_arr)
                    temp_arr = []
                }
                let value = parseInt(branches[i].value)
                temp_arr.push(value)
            }
            branchMatrix.push(temp_arr)

            // Generate Link Array
            temp = link_col_size
            temp_arr = []
            for (var i = 0; i < links.length; i++) {
                if (i % temp == 0 && i != 0) {
                    linkMatrix.push(temp_arr)
                    temp_arr = []
                }
                let value = parseInt(links[i].value)
                temp_arr.push(value)
            }
            linkMatrix.push(temp_arr)


            return {
                branchMatrix,
                linkMatrix
            }

        }
    </script>
</body>

</html>